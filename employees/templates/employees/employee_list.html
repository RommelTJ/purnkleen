{% extends 'base2.html' %}

{% load static %}
{% load employee_extras %}

{% block title %}Pur'N'Kleen Team{% endblock %}

{% block container %}

    <!--page title start-->
    <!--suppress HtmlUnknownTarget -->
    <section class="page-title ptb-70">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h2 class="text-bold">Our Team</h2>
                    <ol class="breadcrumb">
                        <li><a href="{% url 'index' %}">Home</a></li>
                        <li class="active">Our Team</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>
    <!--page title end-->

    <section class="section-padding">
        <div id="team" class="container">

            <div class="text-center mb-80">
                <h1 class="section-title text-uppercase">Current Members</h1>
            </div>

            <div class="row">
                <div class="col-md-offset-1 col-md-10">
                    <div class="row">

                {% if president %}
                <div class="col-md-4 col-sm-6">
                    <div class="team-wrapper text-center">
                        <div class="team-img">
                            <a href="{% url 'employee:detail' president.emp_no %}">
                                <img src="{% if president.image.large.url != None %}{{ president.image.large.url }}{% else %}/media/profile/star_citizen_marine_400x400.jpg{% endif %}"
                                     alt="{{ president.user.first_name }} {{ president.user.last_name }}"
                                     title="{{ president.user.first_name }} {{ president.user.last_name }}"
                                     width="100%"
                                     class="img-responsive">
                            </a>
                        </div><!-- /.team-img -->
                        <div class="team-title">
                            <h3><a href="{% url 'employee:detail' president.emp_no %}">{{ president.user.first_name }} {{ president.user.last_name }}</a></h3>
                            <h4>"{{ president.callsign }}"</h4>
                            <span>President</span>
                        </div><!-- /.team-title -->
                    </div><!-- /.team-wrapper -->
                </div><!-- /.col-md-4 -->
            {% else %} <!-- no president -->
                <div class="col-md-4 col-sm-6">
                    <div class="team-wrapper text-center">
                        <div class="team-img">
                            <a href="#">
                                <img src="/media/profile/star_citizen_marine_400x400.jpg"
                                     alt="No President"
                                     title="No President"
                                     width="100%"
                                     class="img-responsive">
                            </a>
                        </div><!-- /.team-img -->
                        <div class="team-title">
                            <h3><a href="#">Position Available</a></h3>
                            <span>President</span>
                        </div><!-- /.team-title -->
                    </div><!-- /.team-wrapper -->
                </div><!-- /.col-md-4 -->
            {% endif %} <!-- end if president -->

                {% if secretary %}
                    <div class="col-md-4 col-sm-6">
                        <div class="team-wrapper text-center">
                            <div class="team-img">
                                <a href="{% url 'employee:detail' secretary.emp_no %}">
                                    <img src="{% if secretary.image.large.url != None %}{{ secretary.image.large.url }}{% else %}/media/profile/star_citizen_marine_400x400.jpg{% endif %}"
                                         alt="{{ secretary.user.first_name }} {{ secretary.user.last_name }}"
                                         title="{{ secretary.user.first_name }} {{ secretary.user.last_name }}"
                                         width="100%"
                                         class="img-responsive">
                                </a>
                            </div><!-- /.team-img -->
                            <div class="team-title">
                                <h3><a href="{% url 'employee:detail' secretary.emp_no %}">{{ secretary.user.first_name }} {{ secretary.user.last_name }}</a></h3>
                                <h4>"{{ secretary.callsign }}"</h4>
                                <span>Secretary</span>
                            </div><!-- /.team-title -->
                        </div><!-- /.team-wrapper -->
                    </div><!-- /.col-md-3 -->
                {% else %} <!-- no secretary -->
                    <div class="col-md-4 col-sm-6">
                        <div class="team-wrapper text-center">
                            <div class="team-img">
                                <a href="#">
                                    <img src="/media/profile/star_citizen_marine_400x400.jpg"
                                         alt="No Secretary"
                                         title="No Secretary"
                                         width="100%"
                                         class="img-responsive">
                                </a>
                            </div><!-- /.team-img -->
                            <div class="team-title">
                                <h3><a href="#">Position Available</a></h3>
                                <span>Secretary</span>
                            </div><!-- /.team-title -->
                        </div><!-- /.team-wrapper -->
                    </div><!-- /.col-md-4 -->
                {% endif %} <!-- end if secretary -->

                {% if cfo %}
                    <div class="col-md-4 col-sm-6">
                        <div class="team-wrapper text-center">
                            <div class="team-img">
                                <a href="{% url 'employee:detail' cfo.emp_no %}">
                                    <img src="{% if cfo.image.large.url != None %}{{ cfo.image.large.url }}{% else %}/media/profile/star_citizen_marine_400x400.jpg{% endif %}"
                                         alt="{{ cfo.user.first_name }} {{ cfo.user.last_name }}"
                                         title="{{ cfo.user.first_name }} {{ cfo.user.last_name }}"
                                         width="100%"
                                         class="img-responsive">
                                </a>
                            </div><!-- /.team-img -->
                            <div class="team-title">
                                <h3><a href="{% url 'employee:detail' cfo.emp_no %}">{{ cfo.user.first_name }} {{ cfo.user.last_name }}</a></h3>
                                <h4>"{{ cfo.callsign }}"</h4>
                                <span>Chief Financial Officer</span>
                            </div><!-- /.team-title -->
                        </div><!-- /.team-wrapper -->
                    </div><!-- /.col-md-4 -->
                {% else %} <!-- no cfo -->
                    <div class="col-md-4 col-sm-6">
                        <div class="team-wrapper text-center">
                            <div class="team-img">
                                <a href="#">
                                    <img src="/media/profile/star_citizen_marine_400x400.jpg"
                                         alt="No CFO"
                                         title="No CFO"
                                         width="100%"
                                         class="img-responsive">
                                </a>
                            </div><!-- /.team-img -->
                            <div class="team-title">
                                <h3><a href="#">Position Available</a></h3>
                                <span>Chief Financial Officer</span>
                            </div><!-- /.team-title -->
                        </div><!-- /.team-wrapper -->
                    </div><!-- /.col-md-4 -->
                {% endif %} <!-- end if cfo -->
                    </div>
                </div>
            </div> <!-- End Leadership row -->

            <!-- Search -->
            <div class="row">
                <div class="col-md-12">
                    <input id="employee-search" class="form-control" placeholder="Search for..." type="text">
                </div>
            </div> <!-- End Search -->

            <!-- Employees -->
            <div class="row">
                <div class="col-md-12">
                    <ul id='employee-container' data-url='/api/employee/' class="player_list"></ul>
                </div>
            </div><!-- End employees -->
            <a href='#' id='loadmore'>Load More Members</a>

            <!-- Join button -->
            {% if no_account %}
                <div class="row">
                    <div class="col-md-12 text-center">
                        <br/>
                        <a href="{% url 'employee:create' %}">
                            <button type="button" style="width: 50%" class="btn btn-primary btn-lg yellow dark-text waves-effect waves-light">Join Us!</button>
                        </a>
                    </div>
                </div>
            {% endif %} <!-- End Join button -->

        </div>
    </section>


{% endblock %}

{% block script %}
    <script>

        $(document).ready(function(){
            loadEmployeeContainer("employee-container", null);
        });

        <!-- Search Function -->
        $(document).ready(function(){
            var typingTimer;
            var doneInterval = 800; // in ms
            var searchInput = $("#employee-search");
            var searchQuery;

            searchInput.keyup(function(event){
                searchQuery =  $(this).val();
                clearTimeout(typingTimer);
                typingTimer = setTimeout(doneSearchTyping, doneInterval);

            });

            searchInput.keydown(function(event){
                clearTimeout(typingTimer);
            });

            function doneSearchTyping(){
                if (searchQuery){
                    // do search
                    $("#employee-container").empty();
                    loadEmployeeContainer("employee-container", searchQuery);
                } else if (searchQuery === "") {
                    $("#employee-container").empty();
                    loadEmployeeContainer("employee-container", null);
                }
            }
        });
        <!-- End Search -->

        function loadEmployeeContainer(employeeContainerID, query) {
            var employeeList = [];
            var nextEmployeesUrl;

            var employeeContainer;
            if (employeeContainerID) {
                employeeContainer = $("#" + employeeContainerID);
            } else {
                employeeContainer = $("#employee-container")
            }
            var initialURL = employeeContainer.attr("data-url") || "/api/employee/";

            function formatEmployee(employeeValue, evenOrOddStr) {
                var listItemHTML = "<li class='player_row  " + evenOrOddStr + "'>";
                listItemHTML += "<div class='row'>";

                <!-- Employee Info -->
                var employeeInfoHTML = "<div class='player_info_column col-md-9'>";
                employeeInfoHTML += "<div class='row'>";

                <!-- Employee Image -->
                var employeeImageHTML = "<div class='col-md-2 text-center'>";
                employeeImageHTML += "<div class='player_image_container'>";
                employeeImageHTML += "<a href='/team/" + employeeValue.emp_no + "'>";
                var imageURL = "/media/profile/star_citizen_marine_400x400.jpg";
                if (employeeValue.image.medium != null) {
                    imageURL = employeeValue.image.medium;
                }
                employeeImageHTML += "<img src='" + imageURL + "' " +
                    "alt='" + employeeValue.user.first_name + " " + employeeValue.user.last_name + "' " +
                    "title='" + employeeValue.user.first_name + " " + employeeValue.user.last_name + "' " +
                    "width='100%' " +
                    "class='img-rounded'>";
                employeeImageHTML += "</a>";
                employeeImageHTML += "</div>";
                employeeImageHTML += "</div>";
                employeeInfoHTML += employeeImageHTML;
                <!-- End Employee Image -->

                <!-- Employee Description -->
                var employeeDescriptionHTML = "<div class='col-md-10'>";
                employeeDescriptionHTML += "<div class='player_info'>";
                employeeDescriptionHTML += "<div class='player_name'>";
                var countryCode = employeeValue.country.toLowerCase(); // Country codes are required, so this should be safe.
                employeeDescriptionHTML += "<img src='/static/img/flags/svg/" + countryCode + ".svg' height='20'>";
                employeeDescriptionHTML += employeeValue.user.first_name + " \"" + employeeValue.callsign + "\" " + employeeValue.user.last_name;
                employeeDescriptionHTML += "<br/>";
                employeeDescriptionHTML += "<span class='label label-default preferred_activity_small'>";
                employeeDescriptionHTML += employeeValue.primary_activity;
                employeeDescriptionHTML += "</span>";
                employeeDescriptionHTML += "<span class='label label-default preferred_activity_small'>";
                employeeDescriptionHTML += employeeValue.secondary_activity;
                employeeDescriptionHTML += "</span>";
                employeeDescriptionHTML += "</div>";
                employeeDescriptionHTML += "<div>";
                employeeDescriptionHTML += "<div class='player_stat'>";
                employeeDescriptionHTML += "<span class='player_stat_title'>Status: </span>";
                employeeDescriptionHTML += "<span>" + employeeValue.type + "</span>";
                employeeDescriptionHTML += "</div>";
                employeeDescriptionHTML += "<div class='player_stat'>";
                employeeDescriptionHTML += "<span class='player_stat_title'>Hire Date: </span>";
                var hireDate = moment(employeeValue.hire_date).format('D MMMM YYYY');
                employeeDescriptionHTML += "<span>" + hireDate + "</span>";
                employeeDescriptionHTML += "</div>";
                employeeDescriptionHTML += "</div>";
                employeeDescriptionHTML += "</div>";
                employeeDescriptionHTML += "</div>";
                employeeInfoHTML += employeeDescriptionHTML;
                <!-- End Employee Description -->

                employeeInfoHTML += "</div>";
                employeeInfoHTML += "</div>";
                listItemHTML += employeeInfoHTML;
                <!-- End Employee Info -->

                <!-- Employee Actions -->
                var actionsHTML = "<div class='player_actions_column col-md-3 text-center'>";
                actionsHTML += "<div>";
                actionsHTML += "<a href='/team/" + employeeValue.emp_no + "'>";
                actionsHTML += "<button type='button' class='btn btn-primary btn-lg grey light-text waves-effect waves-light'>View more</button>";
                actionsHTML += "</a>";
                actionsHTML += "</div>";
                actionsHTML += "</div>";
                listItemHTML += actionsHTML;
                <!-- End Employee Actions -->

                listItemHTML += "</div>";
                listItemHTML += "</li>";
                return listItemHTML;
            }

            function attachEmployee(employeeValue, evenOrOddStr){
                var employeeFormattedHtml = formatEmployee(employeeValue, evenOrOddStr);
                employeeContainer.append(employeeFormattedHtml);
            }

            function parseEmployees(){
                if (employeeList.length === 0) {
                    employeeContainer.text("No employees currently found.");
                } else {
                    // Employees exist, parse & display them
                    $.each(employeeList, function(employeeKey, value){
                        // Format differently if event or odd.
                        if (employeeKey % 2 === 0) {
                            attachEmployee(value, "even");
                        } else {
                            attachEmployee(value, "odd");
                        }
                    });
                }
            }

            function fetchEmployees(url){
                var fetchUrl;
                if (!url) {
                    fetchUrl = initialURL;
                } else {
                    fetchUrl = url;
                }
                $.ajax({
                    url: fetchUrl,
                    data: {
                        "q": query
                    },
                    method: "GET",
                    success: function(data){
                        employeeList = data.results;

                        if (data.next){
                            nextEmployeesUrl = data.next;
                        } else {
                            $("#loadmore").css("display", "none");
                        }
                        parseEmployees();
                    },
                    error: function(data){
                        console.log("error");
                        console.log(data);
                    }
                });
            }

            fetchEmployees();

            $("#loadmore").click(function(event){
                event.preventDefault();
                if (nextEmployeesUrl) {
                    // load more items
                    fetchEmployees(nextEmployeesUrl);
                }
            });
        }
    </script>
{% endblock %}
